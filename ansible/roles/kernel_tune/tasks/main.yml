---
# roles/kernel_tune/tasks/main.yml
# Applies all sysctl, ulimit, CPU governor, and conntrack tuning.
# Idempotent — safe to re-run.

- name: Install required packages
  ansible.builtin.apt:
    name:
      - iperf3
      - htop
      - numactl
      - linux-tools-common
      - iptables
      - iptables-persistent
    state: present
    update_cache: true

# ── File Descriptors ───────────────────────────────────────────────
- name: Set system-wide file descriptor limits
  ansible.builtin.copy:
    dest: /etc/security/limits.d/99-canvas.conf
    content: |
      # Ansible-managed: canvas-bench file descriptor limits
      * soft nofile 4194304
      * hard nofile 4194304
      root soft nofile 4194304
      root hard nofile 4194304
    owner: root
    group: root
    mode: "0644"

- name: Set fs.file-max and fs.nr_open in sysctl
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { key: fs.file-max,  value: "4194304" }
    - { key: fs.nr_open,   value: "4194304" }

# ── Socket / UDP Buffers ───────────────────────────────────────────
- name: Apply socket and UDP buffer sysctls
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop: "{{ sysctl_params }}"
  vars:
    sysctl_params:
      # Server gets larger buffers (128MB); clients get 64MB — set per group
      - { key: net.core.rmem_max,            value: "{{ rmem_max | default(67108864) }}" }
      - { key: net.core.wmem_max,            value: "{{ wmem_max | default(67108864) }}" }
      - { key: net.core.rmem_default,        value: "{{ rmem_default | default(33554432) }}" }
      - { key: net.core.wmem_default,        value: "{{ wmem_default | default(33554432) }}" }
      - { key: net.ipv4.udp_rmem_min,        value: "65536" }
      - { key: net.ipv4.udp_wmem_min,        value: "65536" }
      - { key: net.ipv4.udp_mem,             value: "8388608 16777216 33554432" }
      - { key: net.core.netdev_max_backlog,   value: "300000" }
      - { key: net.core.somaxconn,           value: "65535" }
      - { key: net.core.optmem_max,          value: "2048000" }
      - { key: net.ipv4.ip_local_port_range, value: "1024 65535" }
      - { key: vm.max_map_count,             value: "16777216" }

# ── Conntrack ──────────────────────────────────────────────────────
# NOTE: All benchmark QUIC traffic is NOTRACK'd (see firewall role), so it
# never creates conntrack entries. nf_conntrack_buckets and UDP timeout sysctls
# (nf_conntrack_udp_timeout, nf_conntrack_udp_timeout_stream) therefore have
# zero effect on benchmark performance — they only affect non-bench traffic like
# SSH. We only set nf_conntrack_max as a safety net to prevent the table from
# filling up and causing errors on that other traffic.
- name: Set nf_conntrack_max (safety net for non-benchmark traffic)
  ansible.posix.sysctl:
    name: net.netfilter.nf_conntrack_max
    value: "2097152"
    sysctl_set: true
    state: present
    reload: true
  ignore_errors: true   # module may not be loaded yet; firewall role loads it

# ── Disable ASLR ──────────────────────────────────────────────────
- name: Disable ASLR for marginal latency improvement
  ansible.posix.sysctl:
    name: kernel.randomize_va_space
    value: "0"
    sysctl_set: true
    state: present
    reload: true

# ── CPU Governor ──────────────────────────────────────────────────
- name: Set CPU scaling governor to performance
  ansible.builtin.shell: |
    for gov in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
      echo performance > "$gov" 2>/dev/null || true
    done
  changed_when: false

- name: Disable irqbalance (IRQs pinned manually by pin_irqs role)
  ansible.builtin.systemd:
    name: irqbalance
    state: stopped
    enabled: false
  ignore_errors: true   # may not be installed

# ── Persist sysctls across reboots ────────────────────────────────
- name: Write canvas sysctl drop-in file for persistence
  ansible.builtin.template:
    src: canvas-sysctl.conf.j2
    dest: /etc/sysctl.d/99-canvas.conf
    owner: root
    group: root
    mode: "0644"
  notify: Reload sysctl
