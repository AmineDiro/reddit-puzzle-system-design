version: '3.8'

networks:
  canvas_net:
    name: canvas_net
    driver: bridge
    ipam:
      config:
        - subnet: 10.5.0.0/16

# Common configuration for high-performance networking and bare-metal access
x-common-config: &common-config
  privileged: true
  ulimits:
    nofile:
      soft: 1048576
      hard: 1048576
    memlock: -1
  sysctls:
    # Namespaced sysctls only. 
    # Global ones (net.core.*) must be set on the host using run_optimized.sh
    - net.ipv4.ip_local_port_range=1024 65535

services:
  server:
    <<: *common-config
    build:
      context: .
      dockerfile: Dockerfile
    networks:
      canvas_net:
        ipv4_address: 10.5.0.10
    # Bind to CCX 0 (Threads 0,1,2 and siblings 6,7,8)
    cpuset: "0,1,2,6,7,8"
    # 1 Master thread + 3 Worker threads
    command: ["server", "--workers", "5"]
    ports:
      - "4433:4433/udp"

  worker_1: &worker-base
    <<: *common-config
    build:
      context: .
      dockerfile: Dockerfile.loadgen
    networks:
      canvas_net:
        ipv4_address: 10.5.0.2
    # Bind to unique cores in CCX 1 to avoid contention
    cpuset: "3,9"
    volumes:
      - ./test_results:/metrics
    command: ["./loadgen", "--target", "https://10.5.0.10:4433", "--clients", "50000", "--id", "worker_1"]

  worker_2:
    <<: *worker-base
    networks:
      canvas_net:
        ipv4_address: 10.5.0.3
    cpuset: "4,10"
    command: ["./loadgen", "--target", "https://10.5.0.10:4433", "--clients", "50000", "--id", "worker_2"]

  worker_3:
    <<: *worker-base
    networks:
      canvas_net:
        ipv4_address: 10.5.0.4
    cpuset: "5,11"
    command: ["./loadgen", "--target", "https://10.5.0.10:4433", "--clients", "50000", "--id", "worker_3"]

  # worker_4:
  #   <<: *worker-base
  #   networks:
  #     canvas_net:
  #       ipv4_address: 10.5.0.5
  #   cpuset: "6,11"
  #   command: ["./loadgen", "--target", "https://10.5.0.10:4433", "--clients", "15000", "--id", "worker_4"]

  # worker_5:
  #   <<: *worker-base
  #   networks:
  #     canvas_net:
  #       ipv4_address: 10.5.0.6
  #   cpuset: "6,11"
  #   command: ["./loadgen", "--target", "https://10.5.0.10:4433", "--clients", "15000", "--id", "worker_5"]